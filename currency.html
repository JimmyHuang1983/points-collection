<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時匯率換算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #3b82f6; color: #ffffff; }
    </style>
</head>
<body class="bg-gray-800 text-gray-200">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">即時匯率換算</h1>
                <p class="text-gray-400 mt-2">您的出國旅遊小幫手</p>
            </div>
            <a href="index.html" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">返回集點趣</a>
        </header>

        <main>
            <div v-if="loading" class="text-center py-10 text-gray-400">
                <p>正在抓取最新匯率資料...</p>
            </div>
            <div v-if="error" class="text-center py-10 text-red-400">
                <p>抱歉，無法載入匯率資料：{{ error }}</p>
            </div>
            
            <div v-if="!loading && !error">
                <!-- Mode Toggle -->
                <div class="bg-gray-700 p-1 rounded-lg flex max-w-xs mx-auto mb-6">
                    <button @click="rateMode = 'live'" :class="{ 'active': rateMode === 'live' }" class="tab-button w-1/2 p-2 rounded-md font-semibold">即時匯率</button>
                    <button @click="rateMode = 'manual'" :class="{ 'active': rateMode === 'manual' }" class="tab-button w-1/2 p-2 rounded-md font-semibold">手動匯率</button>
                </div>

                <!-- Main Converter -->
                <div class="bg-gray-700 p-6 rounded-2xl shadow-lg mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label :for="baseCurrency" class="block text-sm font-medium text-gray-300">{{ getCurrencyName(baseCurrency) }}</label>
                            <input type="number" v-model.number="amount" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm text-white p-3 text-2xl focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center justify-center">
                            <button @click="swapBaseCurrency" class="bg-gray-600 p-3 rounded-full hover:bg-gray-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                            </button>
                        </div>
                        <div class="md:col-span-2">
                            <label for="targetCurrency" class="block text-sm font-medium text-gray-300">換算為</label>
                             <select v-model="targetCurrency" class="mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm text-white p-3 text-2xl focus:ring-blue-500 focus:border-blue-500">
                                <option v-for="c in userCurrencies" :value="c">{{ getCurrencyName(c) }} ({{c}})</option>
                            </select>
                        </div>
                    </div>

                    <!-- Manual Rate Input -->
                    <transition name="fade">
                        <div v-if="rateMode === 'manual'" class="mt-6 border-t border-gray-600 pt-4">
                            <label class="block text-sm font-medium text-gray-300">設定手動匯率 (1 {{ baseCurrency }})</label>
                            <div class="mt-1 flex items-center">
                                <input type="number" step="any" v-model.number="manualRateInput" placeholder="請輸入匯率" class="block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm text-white p-2 text-lg focus:ring-blue-500 focus:border-blue-500">
                                <span class="ml-3 text-lg text-gray-400">{{ targetCurrency }}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">您輸入的匯率將會自動儲存。</p>
                        </div>
                    </transition>

                    <div class="text-center mt-6">
                        <p class="text-gray-400">換算結果</p>
                        <p class="text-4xl font-bold text-green-400">{{ convertedAmount }}</p>
                        <p class="text-sm text-gray-500 mt-2">
                            1 {{ baseCurrency }} ≈ {{ singleUnitRate }} {{ targetCurrency }}
                            <span v-if="rateMode === 'manual'" class="text-yellow-400">(手動)</span>
                            <span v-else class="text-blue-400">(即時)</span>
                        </p>
                    </div>
                </div>

                <!-- Rate Table -->
                <div class="bg-gray-700 p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-white">常用匯率 (以 1 {{ baseCurrency }} 換算)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div v-for="currency in userCurrencies.filter(c => c !== baseCurrency)" :key="currency" class="bg-gray-600 p-3 rounded-lg">
                            <p class="text-sm text-gray-400">{{ getCurrencyName(currency) }} ({{ currency }})</p>
                            <p class="text-lg font-medium text-white">{{ getRateForTable(currency) }}</p>
                        </div>
                    </div>
                </div>

                 <!-- Currency Management -->
                <div class="bg-gray-700 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-white">管理常用幣別</h2>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span v-for="c in userCurrencies" :key="c" class="flex items-center bg-blue-600 text-white px-3 py-1 rounded-full text-sm">
                            {{ getCurrencyName(c) }}
                            <button @click="removeCurrency(c)" class="ml-2 text-blue-200 hover:text-white">&times;</button>
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <select v-model="newCurrency" class="block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm text-white p-2">
                            <option v-for="(name, code) in availableCurrencies" :value="code">{{ name }} ({{code}})</option>
                        </select>
                        <button @click="addCurrency" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">新增</button>
                    </div>
                </div>
                 <p class="text-xs text-gray-500 text-center mt-4">匯率資料於 {{ lastUpdated }} 更新。資料僅供參考。</p>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const loading = ref(true);
                const error = ref(null);
                const rates = ref({});
                const lastUpdated = ref('');
                
                const amount = ref(1000);
                const baseCurrency = ref('TWD');
                const targetCurrency = ref('JPY');
                const newCurrency = ref('USD');

                const rateMode = ref('live'); // 'live' or 'manual'
                const manualRates = ref({}); // Stored as { 'TWD_JPY': 4.5, 'JPY_TWD': 0.22 }
                const manualRateInput = ref(null);

                const userCurrencies = ref(['TWD', 'USD', 'JPY', 'KRW', 'THB', 'MYR', 'PHP']);
                const availableCurrencies = ref({
                    "TWD": "新台幣", "USD": "美元", "JPY": "日圓", "KRW": "韓元", "THB": "泰銖", "MYR": "馬來西亞令吉", "PHP": "菲律賓比索",
                    "EUR": "歐元", "GBP": "英鎊", "AUD": "澳幣", "CAD": "加拿大幣", "CHF": "瑞士法郎", "CNY": "人民幣", "HKD": "港幣", 
                    "SGD": "新加坡幣", "NZD": "紐西蘭幣", "VND": "越南盾", "IDR": "印尼盾"
                });

                const getCurrencyName = (code) => availableCurrencies.value[code] || code;

                const singleUnitRate = computed(() => {
                    if (rateMode.value === 'live') {
                        if (!rates.value[baseCurrency.value] || !rates.value[targetCurrency.value]) return '...';
                        const rate = rates.value[targetCurrency.value] / rates.value[baseCurrency.value];
                        return rate.toFixed(4);
                    } else { // Manual mode
                        return manualRateInput.value > 0 ? manualRateInput.value.toFixed(4) : '...';
                    }
                });

                const convertedAmount = computed(() => {
                    if (singleUnitRate.value === '...') return '...';
                    const result = amount.value * parseFloat(singleUnitRate.value);
                    return new Intl.NumberFormat().format(result.toFixed(2));
                });
                
                const getRateForTable = (target) => {
                    if (rateMode.value === 'live') {
                        if (!rates.value[baseCurrency.value] || !rates.value[target]) return 'N/A';
                        return (rates.value[target] / rates.value[baseCurrency.value]).toFixed(4);
                    } else {
                        const key = `${baseCurrency.value}_${target}`;
                        return manualRates.value[key] ? manualRates.value[key].toFixed(4) : '(未設定)';
                    }
                };

                const swapBaseCurrency = () => {
                    [baseCurrency.value, targetCurrency.value] = [targetCurrency.value, baseCurrency.value];
                };

                const addCurrency = () => {
                    if (newCurrency.value && !userCurrencies.value.includes(newCurrency.value)) {
                        userCurrencies.value.push(newCurrency.value);
                        saveUserCurrencies();
                    }
                };

                const removeCurrency = (currencyCode) => {
                    if (userCurrencies.value.length <= 2) {
                        alert('至少需要保留兩種貨幣。');
                        return;
                    }
                    if (currencyCode === baseCurrency.value || currencyCode === targetCurrency.value) {
                        alert('無法移除正在使用的貨幣。');
                        return;
                    }
                    userCurrencies.value = userCurrencies.value.filter(c => c !== currencyCode);
                    saveUserCurrencies();
                };

                const saveUserCurrencies = () => localStorage.setItem('userCurrencies', JSON.stringify(userCurrencies.value));
                const loadUserCurrencies = () => {
                    const saved = localStorage.getItem('userCurrencies');
                    if (saved) userCurrencies.value = JSON.parse(saved);
                };
                
                const loadManualRateForPair = () => {
                    const key = `${baseCurrency.value}_${targetCurrency.value}`;
                    manualRateInput.value = manualRates.value[key] || null;
                };

                const saveManualRate = () => {
                    if (manualRateInput.value > 0) {
                        const key = `${baseCurrency.value}_${targetCurrency.value}`;
                        const reverseKey = `${targetCurrency.value}_${baseCurrency.value}`;
                        manualRates.value[key] = manualRateInput.value;
                        manualRates.value[reverseKey] = 1 / manualRateInput.value;
                        localStorage.setItem('manualRates', JSON.stringify(manualRates.value));
                    }
                };

                watch(manualRateInput, saveManualRate);
                watch([baseCurrency, targetCurrency], loadManualRateForPair);

                async function fetchRates() {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        rates.value = data.rates;
                        lastUpdated.value = new Date(data.time_last_updated * 1000).toLocaleString('zh-TW');
                    } catch (e) {
                        error.value = e.message;
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                }

                onMounted(() => {
                    loadUserCurrencies();
                    const savedManualRates = localStorage.getItem('manualRates');
                    if (savedManualRates) manualRates.value = JSON.parse(savedManualRates);
                    loadManualRateForPair();
                    fetchRates();
                });

                return {
                    loading, error, amount, baseCurrency, targetCurrency, newCurrency, userCurrencies,
                    availableCurrencies, getCurrencyName, convertedAmount, singleUnitRate, swapBaseCurrency,
                    addCurrency, removeCurrency, lastUpdated, rates, rateMode, manualRateInput, getRateForTable
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

