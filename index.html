<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>親子集點帳本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Heroicons for icons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .icon-button { transition: background-color 0.2s; }
        .icon-button:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4">

        <!-- 登入/註冊畫面 -->
        <transition name="fade">
            <div v-if="!currentUser" class="min-h-screen flex items-center justify-center">
                <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">{{ isRegistering ? '註冊新家庭帳號' : '家庭帳本登入' }}</h2>
                    <div class="space-y-4">
                        <input type="email" v-model="email" placeholder="電子郵件 (作為登入帳號)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="password" v-model="password" @keyup.enter="isRegistering ? handleRegister() : handleLogin()" placeholder="密碼 (至少6位數)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        
                        <button v-if="!isRegistering" @click="handleLogin" :disabled="isLoggingIn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-300 transition-colors">
                            {{ isLoggingIn ? '登入中...' : '登入' }}
                        </button>
                        <button v-if="isRegistering" @click="handleRegister" :disabled="isLoggingIn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-green-300 transition-colors">
                            {{ isLoggingIn ? '註冊中...' : '註冊' }}
                        </button>
                        
                        <p v-if="authError" class="text-red-500 text-sm text-center h-5">{{ authError }}</p>

                        <p class="text-center text-sm text-gray-500">
                            {{ isRegistering ? '已經有帳號了？' : '還沒有帳號嗎？' }}
                            <a href="#" @click.prevent="isRegistering = !isRegistering" class="font-medium text-blue-600 hover:underline">{{ isRegistering ? '直接登入' : '註冊一個' }}</a>
                        </p>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 主應用程式畫面 -->
        <transition name="fade">
            <div v-if="currentUser">
                <header class="bg-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-4">
                             <h1 class="text-3xl font-bold text-gray-800">親子集點帳本</h1>
                             <!-- 編輯模式按鈕 -->
                             <button @click="toggleEditMode" class="p-2 rounded-full icon-button" :class="{'bg-blue-100 text-blue-600': editMode}">
                                 <ion-icon :name="editMode ? 'close-circle' : 'create-outline'" class="text-2xl align-middle"></ion-icon>
                             </button>
                        </div>
                        <p class="text-gray-500 text-sm mt-1">家庭帳號: {{ currentUser.email }}</p>
                    </div>
                    <button @click="handleLogout" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">登出</button>
                </header>
                
                <div v-if="loading" class="text-center py-10"><p>載入中，請稍候...</p></div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 左側操作區 -->
                    <div class="space-y-6">
                        <!-- 孩子切換 -->
                        <div class="bg-white p-2 rounded-lg shadow-sm">
                            <div v-if="editMode" class="p-2">
                                <h4 class="font-bold text-lg text-gray-700 mb-2">編輯孩子</h4>
                                <div v-for="(child, index) in children" :key="child.id" class="flex items-center gap-2 mb-2">
                                    <input type="text" v-model="child.name" placeholder="孩子名稱" class="flex-grow px-2 py-1 border rounded-md">
                                    <button @click="deleteChild(child.id)" class="p-1 text-red-500 hover:text-red-700"><ion-icon name="trash-outline"></ion-icon></button>
                                </div>
                                <button @click="addChild" class="w-full mt-2 text-sm bg-blue-100 text-blue-700 font-semibold py-1 rounded-md hover:bg-blue-200">新增孩子</button>
                                <button @click="saveChildren" class="w-full mt-2 text-sm bg-green-500 text-white font-semibold py-1 rounded-md hover:bg-green-600">儲存孩子變更</button>
                            </div>
                            <div v-else class="flex">
                                <button v-for="child in children" :key="child.id" @click="switchChild(child.name)" :class="['w-full py-2 px-4 rounded-md text-center font-semibold transition-colors', selectedChildName === child.name ? 'bg-blue-500 text-white' : 'bg-transparent text-gray-600 hover:bg-blue-100']">
                                    {{ child.name }} ({{ child.points }}點)
                                </button>
                            </div>
                        </div>

                        <!-- 獎勵區 -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg text-green-700 mb-3">表現優良 (加分)</h4>
                            <div class="space-y-3">
                               <div v-for="item in rewardItems" :key="item.id">
                                    <div v-if="editMode" class="flex items-center gap-2">
                                        <input v-model="item.name" class="flex-grow px-2 py-1 border rounded-md" placeholder="項目名稱">
                                        <input v-model.number="item.points" type="number" class="w-20 px-2 py-1 border rounded-md" placeholder="點數">
                                        <button @click="deleteItem('rewards', item.id)" class="p-1 text-red-500 hover:text-red-700"><ion-icon name="trash-outline"></ion-icon></button>
                                    </div>
                                    <div v-else class="flex flex-wrap items-center">
                                        <div class="flex items-center w-full">
                                            <input type="checkbox" :id="item.id" :value="item" v-model="selectedItems" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                            <label :for="item.id" class="ml-3 block text-sm text-gray-700 flex-grow">{{ item.name }} (+{{ item.points }})</label>
                                        </div>
                                    </div>
                               </div>
                               <div v-if="editMode">
                                    <button @click="addItem('rewards')" class="w-full mt-2 text-sm bg-blue-100 text-blue-700 font-semibold py-1 rounded-md hover:bg-blue-200">新增加分項目</button>
                               </div>
                            </div>
                        </div>

                        <!-- 扣分區 -->
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg text-red-700 mb-3">待改進/兌換 (扣分)</h4>
                             <div class="space-y-3">
                               <div v-for="item in penaltyItems" :key="item.id">
                                    <div v-if="editMode" class="flex items-center gap-2">
                                        <input v-model="item.name" class="flex-grow px-2 py-1 border rounded-md" placeholder="項目名稱">
                                        <input v-model.number="item.points" type="number" class="w-20 px-2 py-1 border rounded-md" placeholder="點數">
                                        <button @click="deleteItem('penalties', item.id)" class="p-1 text-red-500 hover:text-red-700"><ion-icon name="trash-outline"></ion-icon></button>
                                    </div>
                                    <div v-else class="flex flex-wrap items-center">
                                         <div class="flex items-center w-full">
                                            <input type="checkbox" :id="item.id" :value="item" v-model="selectedItems" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500">
                                            <label :for="item.id" class="ml-3 block text-sm text-gray-700 flex-grow">{{ item.name }} (-{{ item.points }})</label>
                                        </div>
                                    </div>
                               </div>
                               <div v-if="editMode">
                                    <button @click="addItem('penalties')" class="w-full mt-2 text-sm bg-blue-100 text-blue-700 font-semibold py-1 rounded-md hover:bg-blue-200">新增扣分項目</button>
                               </div>
                            </div>
                        </div>
                         <button v-if="editMode" @click="saveItems" class="w-full mt-2 text-lg bg-green-500 text-white font-semibold py-2 rounded-md hover:bg-green-600">儲存項目變更</button>
                    </div>

                    <!-- 右側歷史紀錄 -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2">歷史紀錄</h3>
                        <div v-if="summary.descriptiveItems.length > 0" class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold text-blue-800">本次操作總結：</h4>
                            <ul class="list-disc list-inside text-sm">
                                <li v-for="item in summary.descriptiveItems" :key="item.id" :class="item.type === 'rewards' ? 'text-green-600' : 'text-red-600'">{{ item.name }}</li>
                            </ul>
                            <p class="font-bold text-right mt-2 text-lg">
                                總計: <span :class="summary.totalChange >= 0 ? 'text-green-600' : 'text-red-600'">{{ summary.totalChange > 0 ? '+' : '' }}{{ summary.totalChange }}</span> 點
                            </p>
                            <button @click="saveRecord" :disabled="summary.totalChange === 0 || isSaving" class="mt-2 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 disabled:bg-gray-400 transition-colors">
                                {{ isSaving ? '儲存中...' : '儲存紀錄' }}
                            </button>
                        </div>
                        <div class="h-[600px] overflow-y-auto pr-2">
                            <div v-if="history.length === 0" class="text-center text-gray-500 py-10"><p>還沒有任何歷史紀錄</p></div>
                            <div v-else v-for="record in history" :key="record.id" class="mb-3 p-3 border rounded-lg" :class="record.change >= 0 ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'">
                                 <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-gray-700">{{ record.date }}</p>
                                        <ul class="list-none text-sm text-gray-600 mt-1 pl-1"><li v-for="(item, index) in record.items" :key="index">- {{ item.name }}</li></ul>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-2">
                                        <p class="font-bold text-lg" :class="record.change >= 0 ? 'text-green-600' : 'text-red-500'">{{ record.change > 0 ? '+' : '' }}{{ record.change }}</p>
                                        <p v-if="record.balanceAfter !== undefined" class="text-xs text-gray-500 mt-1">結餘: {{ record.balanceAfter }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, runTransaction, writeBatch, getDocs, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

        const app = createApp({
            setup() {
                // --- Auth State ---
                const email = ref('');
                const password = ref('');
                const authError = ref('');
                const isRegistering = ref(false);
                const isLoggingIn = ref(false);
                const currentUser = ref(null);

                // --- App State ---
                const loading = ref(true);
                const editMode = ref(false);
                const children = ref([]);
                const rewardItems = ref([]);
                const penaltyItems = ref([]);
                const history = ref([]);
                const selectedChildName = ref('');
                const selectedItems = ref([]);
                const isSaving = ref(false);
                
                let db, auth;
                let unsubscribes = []; // To store all listeners and detach them on logout

                // Default data for new users
                const createDefaultData = () => ({
                    children: [{ id: 'child-1', name: '孩子一', points: 0 }, { id: 'child-2', name: '孩子二', points: 0 }],
                    rewards: [ { id: 'reward-1', name: '洗碗', points: 20 }, { id: 'reward-2', name: '倒垃圾', points: 10 }, { id: 'reward-3', name: '主動寫功課', points: 20 } ],
                    penalties: [ { id: 'penalty-1', name: '太晚睡覺', points: 10 }, { id: 'penalty-2', name: '忘記簽聯絡簿', points: 5 } ]
                });
                
                // --- Auth Methods ---
                const handleRegister = async () => {
                    if (isLoggingIn.value) return;
                    isLoggingIn.value = true;
                    authError.value = '';
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email.value, password.value);
                        // Create default settings for the new user
                        const defaultData = createDefaultData();
                        const userDocRef = doc(db, 'users', userCredential.user.uid);
                        const batch = writeBatch(db);
                        batch.set(doc(userDocRef, 'settings', 'children'), { list: defaultData.children });
                        batch.set(doc(userDocRef, 'settings', 'rewards'), { list: defaultData.rewards });
                        batch.set(doc(userDocRef, 'settings', 'penalties'), { list: defaultData.penalties });
                        await batch.commit();

                    } catch (error) { authError.value = '註冊失敗：' + error.message;
                    } finally { isLoggingIn.value = false; }
                };

                const handleLogin = async () => {
                    if (isLoggingIn.value) return;
                    isLoggingIn.value = true;
                    authError.value = '';
                    try {
                        await signInWithEmailAndPassword(auth, email.value, password.value);
                    } catch (error) { authError.value = '登入失敗：' + error.message;
                    } finally { isLoggingIn.value = false; }
                };
                
                const handleLogout = async () => {
                    await signOut(auth);
                };
                
                const setupListeners = (userId) => {
                    loading.value = true;
                    detachListeners(); // Clear old listeners before attaching new ones
                    const userDocRef = doc(db, 'users', userId);

                    const listen = (coll, targetRef) => {
                        const unsubscribe = onSnapshot(doc(userDocRef, 'settings', coll), (docSnap) => {
                            if (docSnap.exists()) {
                                targetRef.value = docSnap.data().list || [];
                                // If it's the children list and we haven't selected a child yet, select the first one.
                                if (coll === 'children' && !selectedChildName.value && targetRef.value.length > 0) {
                                    switchChild(targetRef.value[0].name);
                                }
                            }
                        });
                        unsubscribes.push(unsubscribe);
                    };
                    
                    listen('children', children);
                    listen('rewards', rewardItems);
                    listen('penalties', penaltyItems);
                    
                    // Listener for points, needs children to be loaded first
                    watch(children, (newChildren) => {
                        // Detach old point listeners
                        unsubscribes = unsubscribes.filter(unsub => !unsub.isPointsListener);
                        
                        newChildren.forEach(child => {
                            const childHistoryRef = collection(userDocRef, `children/${child.id}/history`);
                            const childDocRef = doc(userDocRef, 'children', child.id);
                             const pointUnsubscribe = onSnapshot(childDocRef, (docSnap) => {
                                const childInArray = children.value.find(c => c.id === child.id);
                                if(childInArray) {
                                    childInArray.points = docSnap.exists() ? docSnap.data().points : 0;
                                }
                            });
                            pointUnsubscribe.isPointsListener = true; // Mark it for easier removal
                            unsubscribes.push(pointUnsubscribe);
                        });
                    }, { deep: true, immediate: true });

                    loading.value = false;
                };

                const detachListeners = () => {
                    unsubscribes.forEach(unsub => unsub());
                    unsubscribes = [];
                };

                // --- App Logic ---
                const toggleEditMode = () => { editMode.value = !editMode.value; };

                // Children Management
                const addChild = () => { children.value.push({ id: `child-${Date.now()}`, name: '新孩子', points: 0 }); };
                const deleteChild = (childId) => { children.value = children.value.filter(c => c.id !== childId); };
                const saveChildren = async () => {
                    const settingsRef = doc(db, `users/${currentUser.value.uid}/settings/children`);
                    await setDoc(settingsRef, { list: JSON.parse(JSON.stringify(children.value)) });
                    alert('孩子列表已更新！');
                };

                // Items Management
                const addItem = (type) => { 
                    const list = type === 'rewards' ? rewardItems.value : penaltyItems.value;
                    list.push({ id: `${type.slice(0, -1)}-${Date.now()}`, name: '新項目', points: 10, type: type });
                };
                const deleteItem = (type, itemId) => {
                    const list = type === 'rewards' ? rewardItems : penaltyItems;
                    list.value = list.value.filter(i => i.id !== itemId);
                };
                 const saveItems = async () => {
                    const batch = writeBatch(db);
                    const rewardsRef = doc(db, `users/${currentUser.value.uid}/settings/rewards`);
                    const penaltiesRef = doc(db, `users/${currentUser.value.uid}/settings/penalties`);
                    batch.set(rewardsRef, { list: JSON.parse(JSON.stringify(rewardItems.value)) });
                    batch.set(penaltiesRef, { list: JSON.parse(JSON.stringify(penaltyItems.value)) });
                    await batch.commit();
                    alert('獎懲項目已更新！');
                };
                
                const switchChild = (name) => {
                    selectedChildName.value = name;
                    clearSelections();
                    
                    // Detach old history listener
                    const oldHistoryUnsub = unsubscribes.find(unsub => unsub.isHistoryListener);
                    if(oldHistoryUnsub) {
                        oldHistoryUnsub();
                        unsubscribes = unsubscribes.filter(unsub => !unsub.isHistoryListener);
                    }
                    
                    const child = children.value.find(c => c.name === name);
                    if (!child) return;

                    const historyCollRef = collection(db, `users/${currentUser.value.uid}/children/${child.id}/history`);
                    const q = query(historyCollRef);
                    const historyUnsubscribe = onSnapshot(q, (snapshot) => {
                        const newHistory = [];
                        snapshot.forEach(doc => newHistory.push({ id: doc.id, ...doc.data() }));
                        history.value = newHistory.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                    });
                    historyUnsubscribe.isHistoryListener = true;
                    unsubscribes.push(historyUnsubscribe);
                };
                
                const clearSelections = () => { selectedItems.value = []; };

                const summary = computed(() => {
                    let totalChange = 0;
                    const descriptiveItems = selectedItems.value.map(item => {
                        const points = item.points || 0;
                        if (item.type === 'rewards') { totalChange += points; }
                        else { totalChange -= points; }
                        return { id: item.id, name: item.name, points, type: item.type };
                    });
                    return { totalChange, descriptiveItems };
                });

                const saveRecord = async () => {
                    if (summary.value.totalChange === 0 || isSaving.value) return;
                    isSaving.value = true;
                    const change = summary.value.totalChange;
                    const child = children.value.find(c => c.name === selectedChildName.value);
                    if (!child) { isSaving.value = false; return; }

                    const itemsToSave = JSON.parse(JSON.stringify(summary.value.descriptiveItems));
                    const childDocRef = doc(db, `users/${currentUser.value.uid}/children`, child.id);
                    const historyCollRef = collection(childDocRef, 'history');
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const childDoc = await transaction.get(childDocRef);
                            let newPoints = change;
                            if (childDoc.exists()) { newPoints = (childDoc.data().points || 0) + change; }
                            transaction.set(childDocRef, { name: child.name, points: newPoints }, { merge: true });
                            const newHistoryRecord = {
                                date: new Date().toLocaleDateString('zh-TW'),
                                timestamp: new Date(),
                                change: change, items: itemsToSave, balanceAfter: newPoints
                            };
                            transaction.set(doc(historyCollRef), newHistoryRecord);
                        });
                        clearSelections();
                    } catch (error) { console.error("儲存紀錄失敗:", error);
                    } finally { isSaving.value = false; }
                };

                // --- Lifecycle ---
                onMounted(() => {
                    const firebaseConfig = {
                      apiKey: "AIzaSyCENfkCWSncwwRxahq4ryCoie4ecVOkG6A",
                      authDomain: "points-collection-cff99.firebaseapp.com",
                      projectId: "points-collection-cff99",
                      storageBucket: "points-collection-cff99.appspot.com",
                      messagingSenderId: "794494861925",
                      appId: "1:794494861925:web:44ed7f07b8870e7b43fc8c"
                    };
                    const firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser.value = user;
                            setupListeners(user.uid);
                        } else {
                            currentUser.value = null;
                            detachListeners();
                            // Reset local state
                            children.value = [];
                            rewardItems.value = [];
                            penaltyItems.value = [];
                            history.value = [];
                            editMode.value = false;
                            loading.value = false;
                        }
                    });
                });

                return { 
                    currentUser, email, password, authError, isRegistering, isLoggingIn, handleRegister, handleLogin, handleLogout,
                    loading, editMode, toggleEditMode,
                    children, rewardItems, penaltyItems, history, selectedChildName,
                    switchChild, selectedItems, summary, isSaving, saveRecord,
                    addChild, deleteChild, saveChildren,
                    addItem, deleteItem, saveItems
                };
            }
        });
        app.mount('#app');
    </script>
</body>
</html>

