<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票投資儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* Chart.js Tooltip Customization */
        .chartjs-tooltip {
            background: rgba(31, 41, 55, 0.9);
            border-radius: 0.5rem;
            color: white;
            opacity: 1;
            pointer-events: none;
            position: absolute;
            transform: translate(-50%, 0);
            transition: all .1s ease;
            padding: 0.5rem;
            border: 1px solid #4b5563;
        }
        .chartjs-tooltip-key {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">股票投資儀表板</h1>
            <p class="text-gray-400 mt-2">紀錄並視覺化您的投資組合表現</p>
        </header>

        <main>
            <!-- Summary Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 mb-8">
                <div class="bg-gray-800 p-4 rounded-2xl shadow-lg text-center">
                    <h3 class="text-sm font-medium text-gray-400">總損益</h3>
                    <p id="totalProfitLoss" class="text-2xl font-semibold mt-1">-</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-2xl shadow-lg text-center">
                    <h3 class="text-sm font-medium text-gray-400">總買賣額 (萬)</h3>
                    <p id="totalBuySell" class="text-2xl font-semibold mt-1">-</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-2xl shadow-lg text-center">
                    <h3 class="text-sm font-medium text-gray-400">最新市值</h3>
                    <p id="latestMarketValue" class="text-2xl font-semibold mt-1">-</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-2xl shadow-lg text-center">
                    <h3 class="text-sm font-medium text-gray-400">歷史最高市值</h3>
                    <p id="highestMarketValue" class="text-2xl font-semibold mt-1">-</p>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg mb-8">
                <canvas id="investmentChart" style="min-height: 400px;"></canvas>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Add New Record Form Section -->
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">新增紀錄</h2>
                    <form id="addRecordForm" class="space-y-4">
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-300">日期</label>
                            <input type="date" id="date" name="date" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2">
                        </div>
                        <div>
                            <label for="marketValue" class="block text-sm font-medium text-gray-300">市值</label>
                            <input type="number" id="marketValue" name="marketValue" required placeholder="例如: 10000000" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2">
                        </div>
                        <div>
                            <label for="profitLoss" class="block text-sm font-medium text-gray-300">損益</label>
                            <input type="number" id="profitLoss" name="profitLoss" required placeholder="例如: 50000 或 -20000" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2">
                        </div>
                        <div>
                            <label for="buySell" class="block text-sm font-medium text-gray-300">買賣 (萬)</label>
                            <input type="number" step="0.1" id="buySell" name="buySell" placeholder="正數為買超, 負數為賣超" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            新增紀錄
                        </button>
                    </form>
                </div>

                <!-- Data Table Section -->
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">歷史紀錄</h2>
                    <div class="overflow-auto max-h-[600px]">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">日期</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">市值</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">損益</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">買賣 (萬)</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- Data will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- INITIAL DATA ---
        // I have cleaned and parsed the new data you provided.
        const initialInvestmentData = [
            { date: "2025-03-31", profitLoss: -230246, marketValue: 10010158, buySell: 0 },
            { date: "2025-04-01", profitLoss: 175663, marketValue: 10185821, buySell: 0 },
            { date: "2025-04-02", profitLoss: 13209, marketValue: 10199030, buySell: 0 },
            { date: "2025-04-07", profitLoss: -911031, marketValue: 9287999, buySell: 0 },
            { date: "2025-04-08", profitLoss: -72378, marketValue: 9215621, buySell: -21.4 },
            { date: "2025-04-09", profitLoss: -473575, marketValue: 8742046, buySell: -8.8 },
            { date: "2025-04-10", profitLoss: 739663, marketValue: 9481709, buySell: 0 },
            { date: "2025-04-11", profitLoss: 28955, marketValue: 9510665, buySell: 0 },
            { date: "2025-04-14", profitLoss: 23720, marketValue: 9345923, buySell: 18.9 },
            { date: "2025-04-15", profitLoss: 156307, marketValue: 9502234, buySell: 0 },
            { date: "2025-04-16", profitLoss: -57944, marketValue: 9444288, buySell: 0 },
            { date: "2025-04-17", profitLoss: 4680, marketValue: 9448966, buySell: 0 },
            { date: "2025-04-18", profitLoss: 25059, marketValue: 9546865, buySell: 0 },
            { date: "2025-04-21", profitLoss: -148680, marketValue: 9398187, buySell: 0 },
            { date: "2025-04-22", profitLoss: -106435, marketValue: 9291550, buySell: 0 },
            { date: "2025-04-23", profitLoss: 198240, marketValue: 9489790, buySell: 0 },
            { date: "2025-04-24", profitLoss: -5078, marketValue: 9484711, buySell: 0 },
            { date: "2025-04-25", profitLoss: 51385, marketValue: 9536099, buySell: 0 },
            { date: "2025-04-28", profitLoss: 20780, marketValue: 9556879, buySell: 0 },
            { date: "2025-04-29", profitLoss: 28971, marketValue: 9585850, buySell: 0 },
            { date: "2025-04-30", profitLoss: 60967, marketValue: 9646815, buySell: 0 },
            { date: "2025-05-02", profitLoss: 106786, marketValue: 9753603, buySell: 0 },
            { date: "2025-05-05", profitLoss: 14213, marketValue: 9767813, buySell: 0 },
            { date: "2025-05-06", profitLoss: 88775, marketValue: 9856590, buySell: 0 },
            { date: "2025-05-07", profitLoss: -329, marketValue: 9856263, buySell: 0 },
            { date: "2025-05-08", profitLoss: 102626, marketValue: 9958886, buySell: 0 },
            { date: "2025-05-09", profitLoss: 57002, marketValue: 10015890, buySell: 0 },
            { date: "2025-05-12", profitLoss: -57754, marketValue: 9725637, buySell: 23.3 },
            { date: "2025-05-13", profitLoss: -102, marketValue: 9725536, buySell: 0 },
            { date: "2025-05-14", profitLoss: 21987, marketValue: 9404024, buySell: 35 },
            { date: "2025-05-15", profitLoss: 23837, marketValue: 9427860, buySell: 0 },
            { date: "2025-05-16", profitLoss: 68685, marketValue: 9496551, buySell: 0 },
            { date: "2025-05-19", profitLoss: -20459, marketValue: 9463620, buySell: 0 },
            { date: "2025-05-20", profitLoss: 29984, marketValue: 9493325, buySell: 0 },
            { date: "2025-05-21", profitLoss: 33804, marketValue: 9527130, buySell: 0 },
            { date: "2025-05-22", profitLoss: -19007, marketValue: 9508120, buySell: 0 },
            { date: "2025-05-23", profitLoss: -4831, marketValue: 9503288, buySell: 0 },
            { date: "2025-05-26", profitLoss: 38679, marketValue: 9541969, buySell: 0 },
            { date: "2025-05-27", profitLoss: -77457, marketValue: 9464510, buySell: 0 },
            { date: "2025-05-28", profitLoss: -30402, marketValue: 9434107, buySell: 0 },
            { date: "2025-05-29", profitLoss: 12749, marketValue: 9446855, buySell: 0 },
            { date: "2025-06-02", profitLoss: -129219, marketValue: 9317634, buySell: 0 },
            { date: "2025-06-03", profitLoss: -37401, marketValue: 9280233, buySell: 0 },
            { date: "2025-06-04", profitLoss: 95151, marketValue: 9375386, buySell: 0 },
            { date: "2025-06-05", profitLoss: -23261, marketValue: 9352123, buySell: 0 },
            { date: "2025-06-06", profitLoss: -40151, marketValue: 9311975, buySell: 0 },
            { date: "2025-06-09", profitLoss: -6506, marketValue: 9305469, buySell: 0 },
            { date: "2025-06-10", profitLoss: 8979, marketValue: 9314448, buySell: 0 },
            { date: "2025-06-11", profitLoss: 4939, marketValue: 9319386, buySell: 0 },
            { date: "2025-06-12", profitLoss: 13763, marketValue: 9333152, buySell: 0 },
            { date: "2025-06-13", profitLoss: -78702, marketValue: 9254448, buySell: 0 },
            { date: "2025-06-16", profitLoss: 39318, marketValue: 9268767, buySell: 0 },
            { date: "2025-06-17", profitLoss: 20366, marketValue: 9288853, buySell: 0 },
            { date: "2025-06-18", profitLoss: 1062, marketValue: 9289637, buySell: 0 },
            { date: "2025-06-19", profitLoss: -83412, marketValue: 9206224, buySell: 0 },
            { date: "2025-06-20", profitLoss: -55302, marketValue: 9150921, buySell: 0 },
            { date: "2025-06-23", profitLoss: -55723, marketValue: 9065196, buySell: 0 },
            { date: "2025-06-24", profitLoss: 127854, marketValue: 9193052, buySell: 0 },
            { date: "2025-06-25", profitLoss: 51510, marketValue: 9244565, buySell: 0 },
            { date: "2025-06-26", profitLoss: 50748, marketValue: 9295313, buySell: 0 },
            { date: "2025-06-27", profitLoss: 153153, marketValue: 9448467, buySell: 0 },
            { date: "2025-06-30", profitLoss: -50149, marketValue: 9395318, buySell: 0 },
            { date: "2025-07-01", profitLoss: 42791, marketValue: 9438112, buySell: 0 },
            { date: "2025-07-02", profitLoss: 35928, marketValue: 9474040, buySell: 0 },
            { date: "2025-07-03", profitLoss: 44328, marketValue: 9518368, buySell: 0 },
            { date: "2025-07-04", profitLoss: -31376, marketValue: 9486992, buySell: 0 },
            { date: "2025-07-07", profitLoss: 37615, marketValue: 9524610, buySell: 0 },
            { date: "2025-07-08", profitLoss: -58134, marketValue: 9466475, buySell: 0 },
            { date: "2025-07-09", profitLoss: 48911, marketValue: 9515385, buySell: 0 },
            { date: "2025-07-10", profitLoss: 33200, marketValue: 9548587, buySell: 0 },
            { date: "2025-07-11", profitLoss: 75941, marketValue: 9624528, buySell: 0 },
            { date: "2025-07-14", profitLoss: 38882, marketValue: 9661111, buySell: 0 },
            { date: "2025-07-15", profitLoss: -16970, marketValue: 9644141, buySell: 0 },
            { date: "2025-07-16", profitLoss: 17590, marketValue: 9655972, buySell: 0 },
            { date: "2025-07-17", profitLoss: 38466, marketValue: 9667158, buySell: 0 },
            { date: "2025-07-18", profitLoss: -10165, marketValue: 9656996, buySell: 0 },
            { date: "2025-07-21", profitLoss: -63245, marketValue: 9593748, buySell: 0 },
            { date: "2025-07-22", profitLoss: -80047, marketValue: 9491749, buySell: 0 },
            { date: "2025-07-23", profitLoss: 94884, marketValue: 9586634, buySell: 0 },
            { date: "2025-07-24", profitLoss: -9655, marketValue: 9457240, buySell: 0 },
            { date: "2025-07-25", profitLoss: -16952, marketValue: 9440288, buySell: 0 },
            { date: "2025-07-28", profitLoss: -2980, marketValue: 9437306, buySell: 0 },
            { date: "2025-07-29", profitLoss: -50048, marketValue: 9387255, buySell: 0 },
            { date: "2025-07-30", profitLoss: 86281, marketValue: 9473539, buySell: 0 },
            { date: "2025-07-31", profitLoss: -80350, marketValue: 9375035, buySell: 0 },
            { date: "2025-08-01", profitLoss: 34826, marketValue: 9409864, buySell: 0 },
            { date: "2025-08-04", profitLoss: 38908, marketValue: 9448771, buySell: 0 },
            { date: "2025-08-05", profitLoss: 84939, marketValue: 9533714, buySell: 0 },
            { date: "2025-08-06", profitLoss: 5425, marketValue: 9539139, buySell: 0 },
            { date: "2025-08-07", profitLoss: -7964, marketValue: 9508133, buySell: 0 },
            { date: "2025-08-08", profitLoss: -73557, marketValue: 9371016, buySell: 0 },
            { date: "2025-08-11", profitLoss: -78162, marketValue: 9292851, buySell: 0 },
            { date: "2025-08-12", profitLoss: 28941, marketValue: 9321795, buySell: 0 },
            { date: "2025-08-13", profitLoss: 102533, marketValue: 9424331, buySell: 0 },
            { date: "2025-08-14", profitLoss: 66498, marketValue: 9490831, buySell: 0 },
            { date: "2025-08-15", profitLoss: 11949, marketValue: 9502782, buySell: 0 },
            { date: "2025-08-18", profitLoss: 53102, marketValue: 9545154, buySell: 0 },
            { date: "2025-08-19", profitLoss: -25203, marketValue: 9488133, buySell: 0 },
            { date: "2025-08-20", profitLoss: -102838, marketValue: 9385293, buySell: 0 },
            { date: "2025-08-21", profitLoss: 57653, marketValue: 9409947, buySell: 0 }
        ];

        let investmentData = [];
        let investmentChart;

        document.addEventListener('DOMContentLoaded', () => {
            // Load data from localStorage or use initial data
            const savedData = localStorage.getItem('investmentData');
            investmentData = savedData ? JSON.parse(savedData) : initialInvestmentData;

            // Set default date for the form
            document.getElementById('date').value = dayjs().format('YYYY-MM-DD');

            // Initial render
            sortData();
            updateSummaryMetrics();
            renderTable();
            renderChart();

            // Setup form submission handler
            const form = document.getElementById('addRecordForm');
            form.addEventListener('submit', handleAddRecord);
        });

        function sortData() {
            investmentData.sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        function saveData() {
            localStorage.setItem('investmentData', JSON.stringify(investmentData));
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num);
        }

        function updateSummaryMetrics() {
            if (investmentData.length === 0) return;

            const totalProfitLoss = investmentData.reduce((acc, cur) => acc + cur.profitLoss, 0);
            const totalBuySell = investmentData.reduce((acc, cur) => acc + (cur.buySell || 0), 0);
            
            const latestRecord = investmentData[investmentData.length - 1];
            const latestMarketValue = latestRecord.marketValue;
            
            const highestMarketValue = Math.max(...investmentData.map(d => d.marketValue));

            const totalPlEl = document.getElementById('totalProfitLoss');
            totalPlEl.textContent = formatNumber(totalProfitLoss);
            totalPlEl.className = `text-2xl font-semibold mt-1 ${totalProfitLoss >= 0 ? 'text-green-400' : 'text-red-400'}`;

            const totalBsEl = document.getElementById('totalBuySell');
            // For Buy/Sell, positive (buy) is cash out (red), negative (sell) is cash in (green)
            totalBsEl.textContent = `${totalBuySell.toFixed(1)}`;
            totalBsEl.className = `text-2xl font-semibold mt-1 ${totalBuySell >= 0 ? 'text-red-400' : 'text-green-400'}`;

            document.getElementById('latestMarketValue').textContent = formatNumber(latestMarketValue);
            document.getElementById('highestMarketValue').textContent = formatNumber(highestMarketValue);
        }

        function renderTable() {
            const tableBody = document.getElementById('recordsTableBody');
            tableBody.innerHTML = ''; // Clear existing rows
            
            [...investmentData].reverse().forEach(record => {
                const row = document.createElement('tr');
                const profitLossClass = record.profitLoss >= 0 ? 'text-green-400' : 'text-red-400';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${record.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-300">${formatNumber(record.marketValue)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${profitLossClass}">${formatNumber(record.profitLoss)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-300">${record.buySell !== 0 ? record.buySell : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderChart() {
            const ctx = document.getElementById('investmentChart').getContext('2d');
            
            if (investmentChart) {
                investmentChart.destroy();
            }

            const labels = investmentData.map(d => d.date);
            const marketValueData = investmentData.map(d => d.marketValue);
            const profitLossData = investmentData.map(d => d.profitLoss);
            
            const minMarketValue = Math.min(...marketValueData);
            const padding = (Math.max(...marketValueData) - minMarketValue) * 0.1; // Add 10% padding

            investmentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: '市值',
                            data: marketValueData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'yMarketValue',
                            tension: 0.1,
                            fill: true,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointBackgroundColor: '#3b82f6'
                        },
                        {
                            type: 'bar',
                            label: '損益',
                            data: profitLossData,
                            backgroundColor: profitLossData.map(p => p >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'),
                            borderColor: profitLossData.map(p => p >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'),
                            borderWidth: 1,
                            yAxisID: 'yProfitLoss',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        },
                        yMarketValue: {
                            type: 'linear',
                            position: 'left',
                            min: minMarketValue - padding, // Adjust scale to show more fluctuation
                            ticks: { 
                                color: '#60a5fa',
                                callback: value => new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(value)
                            },
                            grid: { color: '#374151' },
                            title: { display: true, text: '市值', color: '#60a5fa'}
                        },
                        yProfitLoss: {
                            type: 'linear',
                            position: 'right',
                            ticks: { 
                                color: '#86efac',
                                callback: value => new Intl.NumberFormat('en-US', { notation: 'compact', compactDisplay: 'short' }).format(value)
                            },
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: '損益', color: '#86efac'}
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#d1d5db' } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#4b5563',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                       label += formatNumber(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function handleAddRecord(event) {
            event.preventDefault();
            const form = event.target;
            const newRecord = {
                date: form.date.value,
                marketValue: parseFloat(form.marketValue.value),
                profitLoss: parseFloat(form.profitLoss.value),
                buySell: parseFloat(form.buySell.value) || 0,
            };

            // Simple validation
            if (!newRecord.date || isNaN(newRecord.marketValue) || isNaN(newRecord.profitLoss)) {
                alert('請填寫所有必填欄位 (日期, 市值, 損益)');
                return;
            }

            investmentData.push(newRecord);
            sortData();
            saveData();
            updateSummaryMetrics();
            renderTable();
            renderChart();
            
            form.reset();
            // Set date back to today after reset
            document.getElementById('date').value = dayjs().format('YYYY-MM-DD');
        }
    </script>

</body>
</html>


